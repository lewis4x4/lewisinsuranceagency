name: Daily Article Generation

on:
  schedule:
    # Run at 6 AM EST (11 AM UTC) Monday-Friday
    - cron: '0 11 * * 1-5'
  workflow_dispatch:
    inputs:
      topic_override:
        description: 'Override topic (leave empty to use queue)'
        required: false
        type: string

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  HF_API_KEY: ${{ secrets.HF_API_KEY }}
  HF_API_SECRET: ${{ secrets.HF_API_SECRET }}

jobs:
  generate-article:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install higgsfield-client requests

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get next topic from queue
        id: get-topic
        run: |
          if [ -n "${{ inputs.topic_override }}" ]; then
            echo "topic=${{ inputs.topic_override }}" >> $GITHUB_OUTPUT
            echo "Using override topic: ${{ inputs.topic_override }}"
          else
            # Get the first pending topic
            TOPIC=$(jq -r '.topics[] | select(.status == "pending") | .topic' content/topics-queue.json | head -1)
            if [ -z "$TOPIC" ] || [ "$TOPIC" = "null" ]; then
              echo "No pending topics in queue"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "topic=$TOPIC" >> $GITHUB_OUTPUT
            echo "Found topic: $TOPIC"
          fi

      - name: Generate article with Claude Code
        if: steps.get-topic.outputs.skip != 'true'
        run: |
          TOPIC="${{ steps.get-topic.outputs.topic }}"
          echo "Generating article for: $TOPIC"

          # Run Claude Code with the BlogPublisher skill
          claude -p "Write a blog post about: $TOPIC" --allowedTools "Bash,Read,Write,Edit,Glob,Grep,WebSearch,WebFetch" --max-turns 50

      - name: Mark topic as completed
        if: steps.get-topic.outputs.skip != 'true' && inputs.topic_override == ''
        run: |
          TOPIC="${{ steps.get-topic.outputs.topic }}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Update the topic status to completed
          jq --arg topic "$TOPIC" --arg date "$DATE" '
            .topics |= map(if .topic == $topic then .status = "completed" | .completed_at = $date else . end)
          ' content/topics-queue.json > tmp.json && mv tmp.json content/topics-queue.json

      - name: Commit and push changes
        if: steps.get-topic.outputs.skip != 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Add all generated files
          git add -A

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          TOPIC="${{ steps.get-topic.outputs.topic }}"
          DATE=$(date +"%Y-%m-%d")

          git commit -m "feat(blog): Auto-publish - ${TOPIC}

          Generated by BlogPublisher via GitHub Actions
          Date: ${DATE}

          Co-Authored-By: Claude Code <noreply@anthropic.com>"

          git push

      - name: Summary
        if: steps.get-topic.outputs.skip != 'true'
        run: |
          echo "## Article Generated Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Topic:** ${{ steps.get-topic.outputs.topic }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [articles page](https://lewisinsurance.com/articles) after Netlify deploys." >> $GITHUB_STEP_SUMMARY

      - name: No topics warning
        if: steps.get-topic.outputs.skip == 'true'
        run: |
          echo "## No Pending Topics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The topics queue is empty. Add more topics to \`content/topics-queue.json\`" >> $GITHUB_STEP_SUMMARY
