name: Daily Article Generation

on:
  schedule:
    # Run at 6 AM EST (11 AM UTC) Monday-Friday
    - cron: '0 11 * * 1-5'
  workflow_dispatch:
    inputs:
      topic_override:
        description: 'Override topic (leave empty to use queue)'
        required: false
        type: string

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
  HF_API_KEY: ${{ secrets.HF_API_KEY }}
  HF_API_SECRET: ${{ secrets.HF_API_SECRET }}

permissions:
  contents: write

jobs:
  generate-article:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install higgsfield-client requests

      - name: Install Claude Code CLI
        run: npm install -g @anthropic-ai/claude-code

      - name: Get next topic from queue
        id: get-topic
        run: |
          if [ -n "${{ inputs.topic_override }}" ]; then
            echo "topic=${{ inputs.topic_override }}" >> $GITHUB_OUTPUT
            echo "Using override topic: ${{ inputs.topic_override }}"
          else
            # Get the first pending topic
            TOPIC=$(jq -r '.topics[] | select(.status == "pending") | .topic' content/topics-queue.json | head -1)
            if [ -z "$TOPIC" ] || [ "$TOPIC" = "null" ]; then
              echo "No pending topics in queue"
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "topic=$TOPIC" >> $GITHUB_OUTPUT
            echo "Found topic: $TOPIC"
          fi

      - name: Generate article with Claude Code
        if: steps.get-topic.outputs.skip != 'true'
        run: |
          TOPIC="${{ steps.get-topic.outputs.topic }}"
          echo "Generating article for: $TOPIC"

          # Run Claude Code with the BlogPublisher skill
          claude -p "Write a blog post about: $TOPIC" --allowedTools "Bash,Read,Write,Edit,Glob,Grep,WebSearch,WebFetch" --max-turns 50

      - name: Find generated articles
        if: steps.get-topic.outputs.skip != 'true'
        id: find-articles
        run: |
          # Get current year and month
          YEAR=$(date +"%Y")
          MONTH=$(date +"%m")

          # Find the most recently created article files
          AEO_FILE=$(find content/articles/$YEAR/$MONTH -name "*-aeo.md" -type f -mmin -30 2>/dev/null | head -1)
          GEO_FILE=$(find content/articles/$YEAR/$MONTH -name "*-geo.md" -type f -mmin -30 2>/dev/null | head -1)

          if [ -n "$AEO_FILE" ]; then
            # Extract slug from filename
            SLUG=$(basename "$AEO_FILE" -aeo.md)
            echo "slug=$SLUG" >> $GITHUB_OUTPUT
            echo "year=$YEAR" >> $GITHUB_OUTPUT
            echo "month=$MONTH" >> $GITHUB_OUTPUT

            # Build URLs
            echo "aeo_url=https://lewisinsurance.com/articles/$YEAR/$MONTH/${SLUG}-aeo" >> $GITHUB_OUTPUT
            echo "geo_url=https://lewisinsurance.com/articles/$YEAR/$MONTH/${SLUG}-geo" >> $GITHUB_OUTPUT

            # Extract title from frontmatter
            TITLE=$(grep "^title:" "$AEO_FILE" | sed 's/title: *"//' | sed 's/"$//' | head -1)
            echo "title=$TITLE" >> $GITHUB_OUTPUT

            echo "Found articles: $SLUG"
          else
            echo "No new articles found"
            echo "slug=" >> $GITHUB_OUTPUT
          fi

      - name: Mark topic as completed
        if: steps.get-topic.outputs.skip != 'true' && inputs.topic_override == ''
        run: |
          TOPIC="${{ steps.get-topic.outputs.topic }}"
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Update the topic status to completed
          jq --arg topic "$TOPIC" --arg date "$DATE" '
            .topics |= map(if .topic == $topic then .status = "completed" | .completed_at = $date else . end)
          ' content/topics-queue.json > tmp.json && mv tmp.json content/topics-queue.json

      - name: Commit and push changes
        if: steps.get-topic.outputs.skip != 'true'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Add all generated files
          git add -A

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          TOPIC="${{ steps.get-topic.outputs.topic }}"
          DATE=$(date +"%Y-%m-%d")

          git commit -m "feat(blog): Auto-publish - ${TOPIC}

          Generated by BlogPublisher via GitHub Actions
          Date: ${DATE}

          Co-Authored-By: Claude Code <noreply@anthropic.com>"

          git push

      - name: Send email notification
        if: steps.get-topic.outputs.skip != 'true' && steps.find-articles.outputs.slug != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: true
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: "üìù New Article Published: ${{ steps.find-articles.outputs.title }}"
          to: brian@lewisinsurance.com
          from: Lewis Insurance Bot <${{ secrets.GMAIL_USERNAME }}>
          html_body: |
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
              <h2 style="color: #1C71E2;">New Article Ready for Review</h2>

              <p><strong>Topic:</strong> ${{ steps.get-topic.outputs.topic }}</p>

              <h3>Article Links</h3>
              <p>The article has been published in two versions. Please review:</p>

              <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                <tr>
                  <td style="padding: 12px; background: #f8f9fa; border: 1px solid #dee2e6;">
                    <strong>AEO Version</strong><br>
                    <small>Quick answers for voice search</small>
                  </td>
                  <td style="padding: 12px; background: #f8f9fa; border: 1px solid #dee2e6;">
                    <a href="${{ steps.find-articles.outputs.aeo_url }}" style="color: #1C71E2;">
                      View AEO Article ‚Üí
                    </a>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 12px; border: 1px solid #dee2e6;">
                    <strong>GEO Version</strong><br>
                    <small>Comprehensive guide with sources</small>
                  </td>
                  <td style="padding: 12px; border: 1px solid #dee2e6;">
                    <a href="${{ steps.find-articles.outputs.geo_url }}" style="color: #1C71E2;">
                      View GEO Article ‚Üí
                    </a>
                  </td>
                </tr>
              </table>

              <h3>Quick Actions</h3>
              <ul>
                <li><a href="https://lewisinsurance.com/articles">View All Articles</a></li>
                <li><a href="https://github.com/lewis4x4/lewisinsuranceagency/actions">View GitHub Actions</a></li>
                <li><a href="https://github.com/lewis4x4/lewisinsuranceagency/blob/main/content/topics-queue.json">Manage Topics Queue</a></li>
              </ul>

              <hr style="border: none; border-top: 1px solid #dee2e6; margin: 20px 0;">

              <p style="color: #6c757d; font-size: 12px;">
                This article was automatically generated by BlogPublisher via GitHub Actions.<br>
                Generated: ${{ github.event.repository.updated_at }}
              </p>
            </div>

      - name: Summary
        if: steps.get-topic.outputs.skip != 'true'
        run: |
          echo "## Article Generated Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Topic:** ${{ steps.get-topic.outputs.topic }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.find-articles.outputs.slug }}" ]; then
            echo "### Article URLs" >> $GITHUB_STEP_SUMMARY
            echo "- **AEO:** ${{ steps.find-articles.outputs.aeo_url }}" >> $GITHUB_STEP_SUMMARY
            echo "- **GEO:** ${{ steps.find-articles.outputs.geo_url }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          echo "üìß Email notification sent to brian@lewisinsurance.com" >> $GITHUB_STEP_SUMMARY

      - name: No topics warning
        if: steps.get-topic.outputs.skip == 'true'
        run: |
          echo "## No Pending Topics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The topics queue is empty. Add more topics to \`content/topics-queue.json\`" >> $GITHUB_STEP_SUMMARY
